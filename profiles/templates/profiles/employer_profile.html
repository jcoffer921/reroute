{% extends "base.html" %}
{% load static %}

{% comment %}
  Employer Profile page
  - Clean card layout with a header showing logo/initials and company name
  - Edit Profile button opens a slide-out panel with a form
  - Badge indicates verification status
  - Some fields may not exist on EmployerProfile; we fall back to UserProfile
{% endcomment %}

{% block title %}Employer Profile{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/employer_profile.css' %}">
{% endblock %}

{% block content %}
<div class="employer-profile-page">
  {% if not employer_profile.verified %}
  <div class="alert warning" role="status" style="margin-bottom: 12px;">
    <strong>Pending verification:</strong> We’ll review your company shortly. You’ll receive an email once verified.
  </div>
  {% endif %}
  <!--
    Main profile card: clean surface with a header using flexbox to
    separate the company name (left) and verification badge (right).
  -->
  <section class="card employer-card">
    <header class="profile-header">
      <div class="avatar-wrapper">
        {% if employer_profile.logo %}
          <img src="{{ employer_profile.logo.url }}" alt="{{ employer_profile.company_name|default:'Company' }} logo" class="company-avatar">
        {% else %}
          {% comment %} If we have a company name, show its initial; otherwise show placeholder image {% endcomment %}
          {% if employer_profile.company_name %}
            {% with first=employer_profile.company_name|slice:":1" %}
              <div class="company-avatar avatar-initials">{{ first|upper }}</div>
            {% endwith %}
          {% else %}
            <img src="{% static 'img/company-placeholder.svg' %}" alt="Company placeholder" class="company-avatar">
          {% endif %}
        {% endif %}
      </div>

      <div class="header-details">
        <h1 class="company-name">{{ employer_profile.company_name|default:"Your Company" }}</h1>

        {% comment %} Verification badge (green if verified, yellow otherwise) {% endcomment %}
        {% if employer_profile.verified or employer_profile.user.profile.verified %}
          <span class="badge badge-verified" title="Verified">Verified</span>
        {% else %}
          <span class="badge badge-pending" title="Verification Pending">Pending Verification</span>
        {% endif %}

        {% comment %} Optional action: remove logo when one is set {% endcomment %}
        {% if employer_profile.logo %}
          <form method="post" action="{% url 'remove_employer_logo' %}" style="margin-top: 8px;" onsubmit="return confirm('Are you sure you want to remove your logo?');">
            {% csrf_token %}
            <button type="submit" class="btn btn-secondary">Remove Logo</button>
          </form>
        {% endif %}
      </div>
    </header>

    <div class="card-body">
      {% comment %} Details grid: common employer information {% endcomment %}
      <div class="details-grid">
        <div class="detail">
          <div class="label">Website</div>
          <div class="value">
            {% if employer_profile.website %}
              <a href="{{ employer_profile.website }}" target="_blank" rel="noopener">{{ employer_profile.website }}</a>
            {% else %}
              <span class="muted">Add a website</span>
            {% endif %}
          </div>
        </div>

        <div class="detail full">
          <div class="label">Description</div>
          <div class="value">
            {{ employer_profile.description|default:"Tell candidates about your company and mission." }}
          </div>
        </div>

        <div class="detail">
          <div class="label">Phone</div>
          <div class="value">
            {# If EmployerProfile.phone doesn't exist, show UserProfile phone_number #}
            {% if employer_profile.phone %}
              {{ employer_profile.phone }}
            {% elif employer_profile.user.profile.phone_number %}
              {{ employer_profile.user.profile.phone_number }}
            {% else %}
              <span class="muted">Add a phone number</span>
            {% endif %}
          </div>
        </div>

        <div class="detail">
          <div class="label">State</div>
          <div class="value">
            {% if employer_profile.state %}
              {{ employer_profile.state }}
            {% elif employer_profile.user.profile.state %}
              {{ employer_profile.user.profile.state }}
            {% else %}
              <span class="muted">Add a state</span>
            {% endif %}
          </div>
        </div>

        <div class="detail full">
          <div class="label">Address</div>
          <div class="value">
            {% if employer_profile.address %}
              {{ employer_profile.address }}
            {% else %}
              {% comment %} Fallback to UserProfile address pieces if available {% endcomment %}
              {% if employer_profile.user.profile.street_address or employer_profile.user.profile.city or employer_profile.user.profile.state %}
                {{ employer_profile.user.profile.street_address }}
                {% if employer_profile.user.profile.city %}
                  , {{ employer_profile.user.profile.city }}
                {% endif %}
                {% if employer_profile.user.profile.state %}
                  , {{ employer_profile.user.profile.state }}
                {% endif %}
              {% else %}
                <span class="muted">Add an address</span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Primary action: open editor -->
      <div class="actions">
        <button id="openEditPanel" class="btn btn-primary" type="button">
          Edit Profile
        </button>
      </div>
    </div>
  </section>

  <!--
    Slide-out edit panel:
    - Hidden by default (using .hidden), slides in when .active is applied.
    - Contains EmployerProfileForm rendered via {{ form.as_p }}.
    - Cancel button closes the panel without saving.
  -->
  <aside id="editPanel" class="edit-panel hidden" aria-hidden="true">
    <div class="edit-panel-header">
      <h2>Edit Employer Profile</h2>
      <button id="closeEditPanel" class="btn btn-secondary" type="button" aria-label="Close">
        Cancel
      </button>
    </div>

    <form method="post" enctype="multipart/form-data" class="edit-form">
      {% csrf_token %}
      {{ form.as_p }}

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <button id="cancelInside" type="button" class="btn btn-secondary">Cancel</button>
      </div>
    </form>

    <hr style="margin: 16px 0;">

    <!-- Contact Details (from your personal profile) -->
    <h3>Contact Details</h3>
    <p class="muted">These fields update your account’s contact info used across ReRoute.</p>
    <form method="post" action="{% url 'update_personal_info' %}" class="edit-form">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.path }}">
      <p>
        <label for="emp_phone">Phone Number</label>
        <input type="text" id="emp_phone" name="phone_number" value="{{ employer_profile.user.profile.phone_number }}">
      </p>
      <p>
        <label for="emp_street">Street Address</label>
        <input type="text" id="emp_street" name="street_address" value="{{ employer_profile.user.profile.street_address }}">
      </p>
      <p>
        <label for="emp_city">City</label>
        <input type="text" id="emp_city" name="city" value="{{ employer_profile.user.profile.city }}">
      </p>
      <p>
        <label for="emp_state">State</label>
        <input type="text" id="emp_state" name="state" value="{{ employer_profile.user.profile.state }}" placeholder="e.g., CA">
      </p>
      <p>
        <label for="emp_zip">ZIP Code</label>
        <input type="text" id="emp_zip" name="zip_code" value="{{ employer_profile.user.profile.zip_code }}">
      </p>
      <!-- Optionally allow email update here -->
      <p>
        <label for="emp_email">Contact Email</label>
        <input type="email" id="emp_email" name="personal_email" value="{{ employer_profile.user.profile.personal_email|default:user.email }}">
      </p>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save Contact</button>
      </div>
    </form>
  </aside>
</div>
{% endblock %}

{% block extra_js %}
  <script>
    // Minimal panel toggle logic (inline to avoid missing file)
    (function(){
      const openBtn = document.getElementById('openEditPanel');
      const panel = document.getElementById('editPanel');
      const closeBtn = document.getElementById('closeEditPanel');
      const cancelInside = document.getElementById('cancelInside');
      function open(){
        if(!panel) return;
        panel.classList.remove('hidden');
        panel.classList.add('active');
        panel.setAttribute('aria-hidden','false');
      }
      function close(){
        if(!panel) return;
        panel.classList.remove('active');
        panel.classList.add('hidden');
        panel.setAttribute('aria-hidden','true');
      }
      if (openBtn) openBtn.addEventListener('click', open);
      if (closeBtn) closeBtn.addEventListener('click', close);
      if (cancelInside) cancelInside.addEventListener('click', close);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
    })();
  </script>
{% endblock %}
