{% extends "base.html" %}
{% load static %}

{% block title %}ReRoute | Account Settings{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/settings.css' %}">

<section class="settings-hero">
  <div class="settings-hero-content">
    <h1>Account Settings</h1>
    <p>Manage your account settings and preferences.</p>
  </div>
</section>

<div class="settings-container">

  <!-- Subscription (polished card) -->
  <div class="settings-section">
    <div class="settings-card" role="region" aria-labelledby="heading-subscription">
      <div class="settings-card__head">
        <h3 id="heading-subscription" class="settings-card__title">Subscription</h3>
        <div class="settings-card__actions">
          <a href="{{ subscription_pricing_url }}" class="btn btn-primary" {% if is_employer and not is_verified %}aria-disabled="true" data-disabled="true"{% endif %}>Change Plan</a>
          {% if is_employer %}
            <form method="post" action="{% url 'profiles:cancel_subscription' %}" onsubmit="return confirm('Cancel your subscription and revert to Free?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger">Cancel Subscription</button>
            </form>
          {% endif %}
        </div>
      </div>

      <div class="kv">
        <div class="kv__row">
          <div class="kv__label">Current Plan</div>
          <div class="kv__value plan-name">{{ subscription.plan_name }}</div>
        </div>
        <div class="kv__row">
          <div class="kv__label">Status</div>
          <div class="kv__value">
            <span class="pill {% if subscription.active %}pill--ok{% else %}pill--warn{% endif %}">
              {% if subscription.active %}Active{% else %}Inactive{% endif %}
            </span>
          </div>
        </div>
        {% if is_employer and subscription.expiry_date %}
        <div class="kv__row">
          <div class="kv__label">Next Billing Date</div>
          <div class="kv__value">{{ subscription.expiry_date|date:"F j, Y" }}</div>
        </div>
        {% endif %}
      </div>
    </div>

    {% if is_employer and not is_verified %}
      <p class="help-text" style="margin-top: 0.75rem; color:#b45309;">Your account must be verified before upgrading your plan.</p>
    {% endif %}
  </div>

  <!-- Change Password -->
  <div class="settings-section">
    <h2 id="heading-change-password">Change Password</h2>
    <form method="POST" aria-labelledby="heading-change-password">
      {% csrf_token %}
      <div class="form-group">
        <label for="id_old_password">Current Password</label>
        {{ password_form.old_password }}
      </div>

      <div class="form-group">
        <label for="id_new_password1">New Password</label>
        {{ password_form.new_password1 }}
      </div>

      <div class="form-group">
        <label for="id_new_password2">Confirm Password</label>
        {{ password_form.new_password2 }}
      </div>

      <button type="submit" name="change_password" class="btn-primary">Change Password</button>
    </form>
  </div>

  <!-- Change Email -->
  <div class="settings-section">
    <h2 id="heading-change-email">Change Email</h2>
    <form method="POST" aria-labelledby="heading-change-email">
      {% csrf_token %}
      <div class="form-group">
        <label for="email">Email Address</label>
        <input type="email" name="email" id="email" class="input-small" value="{{ request.user.email }}" placeholder="Email Address" autocomplete="email" required>
      </div>
      <button type="submit" name="update_email" class="btn-primary">Change Email</button>
    </form>
  </div>

  <!-- Account Management -->
  <div class="settings-box danger-zone">
    <h3 id="heading-account-mgmt">Account Management</h3>

    <form method="POST" aria-labelledby="heading-account-mgmt">
      {% csrf_token %}
      <div class="button-row">
        <button type="submit" name="deactivate_account" class="btn btn-secondary">Deactivate Account</button>
        <button type="submit" name="delete_account" class="btn btn-danger" onclick="return confirm('Are you sure? This will permanently delete your account.')">Delete Account</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
