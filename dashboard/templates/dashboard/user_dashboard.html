{% extends "base.html" %}
{% load static %}

{% block title %}User Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/base.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/css/user_dashboard.css' %}">
{% endblock %}

{% block content %}
<section class="dash-hero">
  <div class="dash-hero-content">
    <h1>Welcome, {{ request.user.first_name|default:request.user.username }}!</h1>
  </div>
</section>

<!-- Dashboard Cards -->
<div class="dashboard-container">

  <!-- Progress Carousel -->
  <div class="carousel-box">
    <div class="progress-header">
      <div class="progress-text">
        <h2>Create your path with ReRoute</h2>
        <p>Finish setting up to get matched faster.</p>
      </div>
      <div class="progress-bar-wrapper">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" style="width: 0%;"></div>
        </div>
        <div class="progress-count"><span id="progressCount">0</span>/3</div>
      </div>
    </div>

    <div class="carousel-wrapper">
      <button class="carousel-btn left" onclick="scrollCarousel(-1)" aria-label="Previous">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>

      <div class="carousel-track" id="cardCarousel">
        <!-- Complete Profile -->
        <a href="{% url 'my_profile' %}" class="carousel-card-link">
          <div class="carousel-card">
            <div class="card-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21a8 8 0 0 0-16 0"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div class="card-content">
              <h4 class="card-title">Complete your profile</h4>
              <p>Add more details to qualify for more jobs.</p>
            </div>
            <div class="card-arrow">→</div>
          </div>
        </a>

        <!-- Upload Resume -->
        <a href="{% url 'resumes:resume_welcome' %}" class="carousel-card-link">
          <div class="carousel-card">
            <div class="card-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/>
              </svg>
            </div>
            <div class="card-content">
              <h4 class="card-title">Create a Resume</h4>
              <p>Showcase your skills to stand out.</p>
            </div>
            <div class="card-arrow">→</div>
          </div>
        </a>

        <!-- Saved Jobs -->
        <a href="{% url 'dashboard:saved_jobs' %}" class="carousel-card-link">
          <div class="carousel-card">
            <div class="card-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 21s-6.716-4.271-9.192-6.747C.96 12.406.96 8.994 2.808 7.147a5 5 0 0 1 7.071 0L12 9.268l2.121-2.121a5 5 0 0 1 7.071 7.071C18.716 16.729 12 21 12 21z"/>
              </svg>
            </div>
            <div class="card-content">
              <h4 class="card-title">Saved Jobs</h4>
              <p>View jobs you've bookmarked.</p>
            </div>
            <div class="card-arrow">→</div>
          </div>
        </a>
      </div>

      <button class="carousel-btn right" onclick="scrollCarousel(1)" aria-label="Next">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
    </div>
  </div>

  <!-- ===== Imported Resume Section (if available) ===== -->
  {% if imported_resume %}
    <section class="dashboard-resume-card">
      <h3 class="section-title">
        <span aria-hidden="true" style="margin-right:.35rem;display:inline-flex;vertical-align:middle;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16l4-4h8a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
        </span>
        Imported Resume
      </h3>

      <div class="resume-card-wrapper">
        <div class="resume-thumbnail">
          <img src="{% static 'images/resume_preview.svg' %}" alt="Resume Preview">
        </div>

        <div class="resume-info">
          <p><strong>Summary:</strong> {{ imported_resume.ai_summary|truncatewords:20 }}</p>

          <div class="resume-actions">
            <a href="{% url 'resumes:imported_resume' imported_resume.id %}" class="btn btn-primary">View Details</a>
            {% if imported_resume.file %}
              <a href="{{ imported_resume.file.url }}" class="btn btn-outline" target="_blank">Download File</a>
            {% else %}
              <span class="text-muted">No file uploaded</span>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
  {% endif %}

  <!-- ===== Created Resume Section (if available) ===== -->
  {% if resume %}
    <section class="dashboard-resume-card">
      <h3 class="section-title">
        <span aria-hidden="true" style="margin-right:.35rem;display:inline-flex;vertical-align:middle;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7l8 8"/><path d="M14.7 6.3a1 1 0 0 1 1.4 0l1.6 1.6a1 1 0 0 1 0 1.4L9 18H6v-3z"/></svg>
        </span>
        Your Created Resume
      </h3>

      <div class="resume-info">
        <p>{{ resume.ai_summary|default:"No summary available yet." }}</p>
        <a href="{% url 'resumes:created_resume_view' resume.id %}" class="btn btn-primary">View Resume</a>
      </div>
    </section>
  {% else %}
    <section class="dashboard-resume-card">
      <p>You haven't created a resume yet. <a href="{% url 'resumes:resume_welcome' %}">Start here</a></p>
    </section>
  {% endif %}

  <!-- Suggested Jobs -->
  <div class="suggested-box">
    <div class="suggested-header">
      <a href="{% url 'dashboard:matched_jobs' %}" class="suggested-jobs-link">
        <h2>Suggested Jobs</h2>
        <p>Based on your skills and interests</p>
      </a>
    </div>
    <div class="suggested-wrapper">
      {% if suggested_jobs %}
      <button class="carousel-btn left" onclick="scrollSuggested(-1)" aria-label="Previous">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      {% endif %}

      <div class="carousel-track" id="suggestedJobsCarousel">
        {% for job in suggested_jobs %}
            <div class="carousel-card job-card">
              <div class="card-content">
                <h4>{{ job.title }}</h4>
                <p class="job-meta">{{ job.location }} — {{ job.employer }}</p>
                <p class="job-description">{{ job.description|truncatechars:100 }}</p>
              </div>
            <a href="{% url 'job_detail' job.id %}" class="card-arrow" aria-label="View job">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
            </a>
            </div>
        {% empty %}
          <div class="empty-state">
            <div class="empty-icon" aria-hidden="true">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            </div>
            <h4>No job suggestions yet</h4>
            <p>Complete your profile and add skills to see matches tailored to you.</p>
            <div class="empty-actions">
              <a href="{% url 'my_profile' %}" class="btn btn-outline">Complete Profile</a>
              <a href="{% url 'resumes:resume_welcome' %}" class="btn btn-primary">Create Resume</a>
              <a href="{% url 'opportunities' %}" class="btn btn-outline">Browse Jobs</a>
            </div>
          </div>
        {% endfor %}
      </div>
      {% if suggested_jobs %}
      <button class="carousel-btn right" onclick="scrollSuggested(1)" aria-label="Next">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Tips -->
  <div class="tips-box rotating">
    <div class="tips-header">
      <h2>Helpful Tips</h2>
      <p>Advice to help you get the most out of ReRoute</p>
    </div>
    <div id="tipText" class="tip-item">Loading tips...</div>
    <button id="nextTipBtn" class="next-tip-btn">
      Next Tip
      <span aria-hidden="true" style="display:inline-flex;vertical-align:middle;margin-left:.35rem;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
      </span>
    </button>
  </div>
</div>

<script src="{% static 'dashboard/js/user_dashboard.js' %}"></script>
{% endblock %}
