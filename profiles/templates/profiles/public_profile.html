{% extends "base.html" %}
{% load static %}

{% block title %}ReRoute | Profile{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/public_profile.css' %}">

<section class="profile-hero">
  <div class="profile-hero-content">
    <h1>Who You Are</h1>
    <p>Joined: {{ user.date_joined|date:"F j, Y" }}</p>
    <p>Status: <span class="account-status">{{ profile.account_status|capfirst }}</span></p>
    
  </div>
</section>

<div class="profile-container">
  <div class="profile-header">

    <!-- Center: Picture + Name + Badge + ID -->
    <div class="profile-section profile-center">
      <form method="POST" enctype="multipart/form-data" action="{% url 'update_profile_picture' %}">
        {% csrf_token %}
        <label for="profilePicInput" class="profile-picture-wrapper">
          {% if profile.profile_picture %}
            <img src="{{ profile.profile_picture.url }}" class="profile-picture" alt="Profile Picture">
          {% else %}
            <img src="{% static 'images/default-avatar.png' %}" class="profile-picture" alt="Default Avatar">
          {% endif %}
          <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicChange(this);">
        </label>
      </form>
      <!-- Profile Picture Modal -->
      <div id="profilePicModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000;">
        <div style="background: white; margin: 10% auto; padding: 20px; width: 300px; text-align: center;">
          <h3>Update Profile Picture</h3>
          <img id="previewImage" src="" style="width: 100%; height: auto; margin-bottom: 10px;" />
          <form id="profilePicForm" method="POST" enctype="multipart/form-data" action="{% url 'update_profile_picture' %}">
            {% csrf_token %}
            <input type="file" id="modalPicInput" name="profile_picture" accept="image/*" style="display: none;" />
            <button type="submit">Save</button>
            <button type="button" onclick="removeProfilePicture()">Remove</button>
            <button type="button" onclick="closeModal()">Cancel</button>
          </form>
        </div>
      </div>


      <h2 class="profile-name">
        {% if profile.firstname %}
          {{ profile.firstname }} (@{{ user.username }})
        {% else %}
          @{{ user.username }}
        {% endif %}
      </h2>

      <p class="user-id">
        User ID: <span class="uid">{{ profile.user_uid|stringformat:"s" }}</span>
      </p>


      {% if profile.verified %}
        <span class="verified-badge">Verified</span>
      {% endif %}
    </div>

  </div>

  <div class="profile-bio">
  <h3><strong>About:</strong></h3>

  <!-- Bio Display -->
  <p id="bioPreview">
    {% if profile.bio %}
      {{ profile.bio|truncatechars:200 }}
      {% if profile.bio|length > 200 %}
        <span id="showMoreBtn" style="color: blue; cursor: pointer;" onclick="toggleBio()">Show more</span>
      {% endif %}
    {% else %}
      <em>No bio yet.</em>
    {% endif %}
  </p>

  <!-- Hidden full bio -->
  <p id="fullBio" style="display: none;">{{ profile.bio }}</p>

  <!-- Edit Bio Button (Only show if it's the user's profile) -->
  {% if user == request.user %}
    <button onclick="toggleBioEdit()">Edit Bio</button>

    <!-- Hidden form for editing bio -->
    <form id="editBioForm" method="POST" action="{% url 'update_bio' %}" style="display: none;">
      {% csrf_token %}
      <textarea name="bio" rows="4" cols="50">{{ profile.bio }}</textarea><br>
      <button type="submit">Save</button>
      <button type="button" onclick="toggleBioEdit()">Cancel</button>
    </form>
  {% endif %}
</div>
<script src="{% static 'js/public_profile.js' %}" defer></script>
{% endblock %}